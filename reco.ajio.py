import streamlit as st
import pandas as pd
import base64
import io

def process_data(df):
    """
    рдпрд╣рд╛рдВ рдЖрдк рдЕрдкрдирд╛ рд╕рд╛рд░рд╛ рдбреЗрдЯрд╛ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рд▓реЙрдЬрд┐рдХ рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВред
    рдЕрднреА рдХреЗ рд▓рд┐рдП, рд╣рдо рд╕рд┐рд░реНрдл рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдкрдВрдХреНрддрд┐рдпреЛрдВ (rows) рдХреЛ рд╣рдЯрд╛ рд░рд╣реЗ рд╣реИрдВред
    """
    # рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдкрдВрдХреНрддрд┐рдпреЛрдВ рдХреЛ рд╣рдЯрд╛рдПрдВ
    df_processed = df.drop_duplicates()
    
    # рдЖрдк рдпрд╣рд╛рдВ рдФрд░ рднреА рд╕рдлрд╛рдИ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ:
    # df_processed = df_processed.dropna() # рдЦрд╛рд▓реА рдкрдВрдХреНрддрд┐рдпрд╛рдВ рд╣рдЯрд╛рдирд╛
    
    return df_processed

def get_csv_download_link(df, filename="processed_data.csv"):
    """
    рдкреНрд░реЛрд╕реЗрд╕ рдХрд┐рдП рдЧрдП DataFrame рдХреЛ CSV рдбрд╛рдЙрдирд▓реЛрдб рд▓рд┐рдВрдХ рдореЗрдВ рдмрджрд▓рдиреЗ рдХрд╛ рдлрд╝рдВрдХреНрд╢рдиред
    """
    # DataFrame рдХреЛ CSV рдореЗрдВ рдмрджрд▓реЗрдВ
    csv = df.to_csv(index=False)
    
    # CSV рдбреЗрдЯрд╛ рдХреЛ рдПрдиреНрдХреЛрдб рдХрд░реЗрдВ
    b64 = base64.b64encode(csv.encode()).decode()
    
    # рдбрд╛рдЙрдирд▓реЛрдб рд▓рд┐рдВрдХ HTML
    href = f'<a href="data:file/csv;base64,{b64}" download="{filename}">Processed Data рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ (.csv)</a>'
    return href

def get_txt_download_link(df, filename="processed_data.txt"):
    """
    рдкреНрд░реЛрд╕реЗрд╕ рдХрд┐рдП рдЧрдП DataFrame рдХреЛ TXT рдбрд╛рдЙрдирд▓реЛрдб рд▓рд┐рдВрдХ рдореЗрдВ рдмрджрд▓рдиреЗ рдХрд╛ рдлрд╝рдВрдХреНрд╢рдиред
    """
    # DataFrame рдХреЛ рдЯреИрдм-рд╕реЗрдкрд░реЗрдЯреЗрдб рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рдмрджрд▓реЗрдВ
    # рдЖрдк рдЕрдкрдиреА рдЬрд╝рд░реВрд░рдд рдХреЗ рд╣рд┐рд╕рд╛рдм рд╕реЗ рд╕реЗрдкрд░реЗрдЯрд░ (sep) рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ
    txt = df.to_csv(index=False, sep='\t')
    
    # рдбреЗрдЯрд╛ рдХреЛ рдПрдиреНрдХреЛрдб рдХрд░реЗрдВ
    b64 = base64.b64encode(txt.encode()).decode()
    
    # рдбрд╛рдЙрдирд▓реЛрдб рд▓рд┐рдВрдХ HTML
    href = f'<a href="data:file/text;base64,{b64}" download="{filename}">Processed Data рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ (.txt)</a>'
    return href

# --- Streamlit рдРрдк ---

st.title("ЁЯУД рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдбреЗрдЯрд╛ рд░рд┐рдореВрд╡рд░ рдЯреВрд▓")
st.write("рдПрдХ CSV рдпрд╛ TXT рдлрд╝рд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ, рдпрд╣ рдЯреВрд▓ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдкрдВрдХреНрддрд┐рдпреЛрдВ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ рдФрд░ рдЖрдкрдХреЛ рд╕рд╛рдлрд╝ рдлрд╝рд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рджреЗрдЧрд╛ред")

# 1. рдлрд╝рд╛рдЗрд▓ рдЕрдкрд▓реЛрдбрд░
uploaded_file = st.file_uploader("рдЕрдкрдиреА CSV рдпрд╛ TXT рдлрд╝рд╛рдЗрд▓ рдЪреБрдиреЗрдВ", type=["csv", "txt"])

if uploaded_file is not None:
    try:
        # рдлрд╝рд╛рдЗрд▓ рдХреЗ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ
        file_extension = uploaded_file.name.split('.')[-1].lower()
        
        # рдлрд╝рд╛рдЗрд▓ рдкрдврд╝реЗрдВ
        if file_extension == 'csv':
            # рдпрд╣ рдорд╛рдирдХрд░ рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ рдХрд┐ рдлрд╝рд╛рдЗрд▓ рдХреЙрдорд╛ (,) рд╕реЗрдкрд░реЗрдЯреЗрдб рд╣реИ
            df = pd.read_csv(uploaded_file)
        elif file_extension == 'txt':
            # рдпрд╣ рдорд╛рдирдХрд░ рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ рдХрд┐ рдлрд╝рд╛рдЗрд▓ рдЯреИрдм (\t) рд╕реЗрдкрд░реЗрдЯреЗрдб рд╣реИ
            # рдЕрдЧрд░ рд╕реЗрдкрд░реЗрдЯрд░ рдХреБрдЫ рдФрд░ рд╣реИ, рддреЛ рдЗрд╕реЗ рдпрд╣рд╛рдВ рдмрджрд▓реЗрдВ (рдЬреИрд╕реЗ sep=';')
            df = pd.read_csv(uploaded_file, sep='\t')

        st.success("рдлрд╝рд╛рдЗрд▓ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрд▓реЛрдб рд╣реЛ рдЧрдИ!")
        st.write("---")

        # 2. рдбреЗрдЯрд╛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░реЗрдВ
        st.header("1. рдбреЗрдЯрд╛ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ")
        if st.button("рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдкрдВрдХреНрддрд┐рдпрд╛рдВ рд╣рдЯрд╛рдПрдВ"):
            
            original_rows = len(df)
            st.write(f"рдУрд░рд┐рдЬрд┐рдирд▓ рдбреЗрдЯрд╛ рдореЗрдВ рдкрдВрдХреНрддрд┐рдпрд╛рдВ: **{original_rows}**")

            # рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВ
            df_cleaned = process_data(df)
            
            cleaned_rows = len(df_cleaned)
            removed_rows = original_rows - cleaned_rows
            
            st.info(f"рд╕рд╛рдлрд╝ рдХрд┐рдП рдЧрдП рдбреЗрдЯрд╛ рдореЗрдВ рдкрдВрдХреНрддрд┐рдпрд╛рдВ: **{cleaned_rows}**")
            st.warning(f"рд╣рдЯрд╛рдИ рдЧрдИ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдкрдВрдХреНрддрд┐рдпрд╛рдВ: **{removed_rows}**")
            
            st.write("---")

            # 3. рдбрд╛рдЙрдирд▓реЛрдб рд╕реЗрдХреНрд╢рди
            st.header("2. рд╕рд╛рдлрд╝ рдбреЗрдЯрд╛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ")
            
            # рдкреНрд░реАрд╡реНрдпреВ рджрд┐рдЦрд╛рдПрдВ
            st.subheader("рд╕рд╛рдлрд╝ рдбреЗрдЯрд╛ рдХрд╛ рдкреНрд░реАрд╡реНрдпреВ (рдкрд╣рд▓реА 10 рдкрдВрдХреНрддрд┐рдпрд╛рдВ)")
            st.dataframe(df_cleaned.head(10))

            # рдбрд╛рдЙрдирд▓реЛрдб рд▓рд┐рдВрдХ
            st.subheader("рдбрд╛рдЙрдирд▓реЛрдб рд▓рд┐рдВрдХ")
            
            # CSV рд▓рд┐рдВрдХ
            csv_link = get_csv_download_link(df_cleaned, "cleaned_data.csv")
            st.markdown(csv_link, unsafe_allow_html=True)
            
            # TXT рд▓рд┐рдВрдХ
            txt_link = get_txt_download_link(df_cleaned, "cleaned_data.txt")
            st.markdown(txt_link, unsafe_allow_html=True)
            
            # рд╕реЗрд╢рди рд╕реНрдЯреЗрдЯ рдореЗрдВ рд╕рд╛рдлрд╝ рдбреЗрдЯрд╛ рд╕реЗрд╡ рдХрд░реЗрдВ (рдЬрд╝рд░реВрд░реА рдирд╣реАрдВ, рд▓реЗрдХрд┐рди рдЙрдкрдпреЛрдЧреА)
            st.session_state['cleaned_df'] = df_cleaned

    except Exception as e:
        st.error(f"рдлрд╝рд╛рдЗрд▓ рдкрдврд╝рдиреЗ рдореЗрдВ рдЧрдбрд╝рдмрдбрд╝реА рд╣реБрдИ: {e}")
        st.error("рдХреГрдкрдпрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдлрд╝рд╛рдЗрд▓ рд╕рд╣реА рдлреЙрд░реНрдореЗрдЯ (CSV рдпрд╛ TXT) рдореЗрдВ рд╣реИред")
